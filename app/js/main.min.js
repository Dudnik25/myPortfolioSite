'use strict';

window.requestAnimFrame = function () {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function (callback, element) {
        window.setTimeout(function () {
            callback(+new Date());
        }, 1000 / 60);
    };
}();

var content = document.querySelector('.content');

var canvas = document.getElementById('canvasB');
var ctx = canvas.getContext('2d');

var width = window.innerWidth;
var height = window.innerHeight;
ctx.canvas.width = width;
ctx.canvas.height = height;

var center = { x: width / 2, y: height / 2 };
var stars = [];
var starsCount = 0;
if (width < 1000) {
    starsCount = 200;
} else {
    starsCount = 600;
}

var Z = 0.1;
var WarpZ = 12;
var alpha = 0.25;
var lineW = 5;
var WarpDrive = false;

var cx = center.x - width / 2 + width / 2;
var cy = center.y - height / 2 + height / 2;

var cycle = 0;

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
}

var speed = 0;

window.addEventListener('keypress', warp);
canvas.addEventListener('touchstart', warp);
canvas.addEventListener('touchend', warp);
window.addEventListener('resize', resize);
canvas.addEventListener('animationend', function (e) {
    if (e.animationName === 'scale') {
        content.classList.remove('animscale');
        content.classList.add('hidden');
    }
    if (e.animationName === 'scale2') {
        content.style.opacity = 1;
        content.classList.remove('animscale2');
    }
});

function warp(e) {
    if (e.code === 'KeyW' || e.keyCode === 119 || e.type === 'touchstart') {
        console.log('KeyW' + WarpDrive);
        if (WarpDrive === false && speed === 0) {
            WarpDrive = true;
            console.log('Warp Drive On!');
            var speedup = setInterval(function () {
                speed += 1;
                console.log('Warp Drive Speed: ' + speed);
                Z += 0.08;
                alpha -= 0.015;
                starsCount += 50;
                lineW += 0.25;
                if (speed >= 10) clearInterval(speedup);
            }, 200);
        }
    }

    if (e.code === 'KeyS' || e.keyCode === 115 || e.type === 'touchend') {
        console.log('KeyS' + WarpDrive);
        if (WarpDrive === true && speed === 10) {
            WarpDrive = false;
            console.log('Warp Drive Off!');
            var speeddown = setInterval(function () {
                speed -= 1;
                console.log('Warp Drive Speed: ' + speed);
                Z -= 0.08;
                alpha += 0.015;
                starsCount -= 50;
                lineW -= 0.25;
                if (speed <= 0) clearInterval(speeddown);
            }, 100);
        }
    }
}

function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    ctx.canvas.width = width;
    ctx.canvas.height = height;

    center = { x: width / 2, y: height / 2 };
    cx = center.x - width / 2 + width / 2;
    cy = center.y - height / 2 + height / 2;
}

function starMove() {
    for (var i = 0; i < stars.length; i++) {
        if (stars[i].px <= width && stars[i].px + cx >= 0 && stars[i].py <= height && stars[i].py + cy >= 0 && stars[i].z > Z) {
            // console.log(stars[i].px + " : " + stars[i].py);
            stars[i].px = stars[i].x / stars[i].z;
            stars[i].py = stars[i].y / stars[i].z;
            stars[i].o += Z;
            stars[i].z -= Z;
        } else {
            stars.splice(i, 1);
            //console.log(stars.length);
        }
    }
}

function StarCreate() {
    if (stars.length < starsCount) {
        for (var i = stars.length; i < starsCount; i++) {
            var star = {};
            star.x = (Math.random() * width - width * 0.5) * WarpZ;
            star.y = (Math.random() * height - height * 0.5) * WarpZ;
            star.z = WarpZ;
            star.c = 'rgba(' + 140 + ',' + getRandomInt(220, 255) + ',' + 255 + ', 1)';
            star.px = 0;
            star.py = 0;
            stars.push(star);
        }
    }
}

function drawStars() {
    for (var i = 0; i < stars.length; i++) {
        var star = stars[i];

        var color = 'rgba(' + Math.random() * 255 + ',' + 255 + ',' + 255 + ',' + 1 + ')';
        if (star.px !== 0) {
            var xx = star.x / star.z;
            var xy = star.y / star.z;
            ctx.strokeStyle = star.c;
            ctx.lineWidth = getRandomInt(1, 5);
            ctx.beginPath();
            ctx.moveTo(star.px + cx, star.py + cy);
            ctx.lineTo(xx + cx, xy + cy);
            ctx.stroke();
        }
    }
}

function drawBackground() {
    ctx.globalAlpha = alpha;
    ctx.fillStyle = "rgba(0, 0, 0, 1)";
    ctx.fillRect(0, 0, width, height);
}

function timer() {
    ctx.font = "48px serif";
    ctx.fillStyle = 'white';
    ctx.fillText(cycle, 50, 50);

    cycle = cycle >= 60 ? 1 : ++cycle;
}

function drawHUD() {
    // ctx.globalAlpha = 1;
    // ctx.beginPath();
    // ctx.lineWidth = 10;
    // ctx.strokeStyle = '#05e6ff';
    // ctx.arc(300, 300, 200, 0, 2 * Math.PI);
    // ctx.stroke();

    drawSpeed();
}
var step = 10;
function drawSpeed() {
    var speedometerWidth = width / 3 < 300 ? 300 : width / 3;
    var speedometerHeight = height / 20;
    var startWidth = center.x - speedometerWidth / 2;
    var startHeight = height - (speedometerHeight + 50);
    var stepHeight = speedometerHeight - 10;
    var stepMargin = (speedometerWidth - 5) / step;
    var stepWidth = (speedometerWidth - 5) / step - 5;
    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#05e6ff';
    ctx.rect(startWidth, startHeight, speedometerWidth, speedometerHeight);
    ctx.stroke();

    ctx.globalAlpha = 0.25;
    ctx.beginPath();
    ctx.fillStyle = '#05e6ff';
    ctx.rect(startWidth + 5, startHeight + 5, stepWidth, stepHeight);
    ctx.fill();
    if (speed !== 0) {
        var stepC = step / 10 * speed;
        for (var i = 1; i < stepC; i++) {
            ctx.beginPath();
            ctx.fillStyle = '#05e6ff';
            ctx.rect(startWidth + stepMargin * i + 5, startHeight + 5, stepWidth, stepHeight);
            ctx.fill();
        }
    }
}

function render() {

    drawBackground();
    StarCreate();
    starMove();
    drawStars();
    drawHUD();

    timer();
    requestAnimationFrame(render);
}

var input = document.getElementById('speed');
input.addEventListener('input', function (e) {
    step = e.target.value;
});

render();